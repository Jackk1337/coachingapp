rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if document ID matches user ID pattern (userId_*)
    function isUserDocument(docId) {
      return isAuthenticated() && docId.matches(request.auth.uid + '_.*');
    }
    
    // Check if user is the creator (handles both create and update operations)
    function isCreator() {
      return isAuthenticated() && (
        // For create operations, check request.resource
        (request.resource != null && request.resource.data.createdBy == request.auth.uid) ||
        // For update/delete operations, check existing resource
        (resource != null && resource.data.createdBy == request.auth.uid)
      );
    }
    
    // ============================================
    // USER & PROFILE COLLECTIONS
    // ============================================
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isOwner(userId);
      
      // Subscriptions subcollection - users can read their own subscriptions
      match /subscriptions/{subscriptionId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only server-side (Stripe webhooks) should write subscriptions
      }
    }
    
    // Profiles collection - users can read all profiles (for community features), write only their own
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isOwner(profileId);
    }
    
    // ============================================
    // MESSAGING
    // ============================================
    
    // Messages collection - users can only read/write their own messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Daily coach messages collection - users can only read their own messages
    // Write operations are handled server-side via API routes (using Admin SDK)
    match /daily_coach_messages/{messageId} {
      allow read: if isAuthenticated() && (
        isUserDocument(messageId) ||
        resource.data.userId == request.auth.uid
      );
      // Write operations are handled server-side via API routes
      allow write: if false;
    }
    
    // ============================================
    // COACHES
    // ============================================
    
    // Default coaches collection - authenticated users can read, no client writes (admin only)
    match /coaches/{coachId} {
      allow read: if isAuthenticated();
      // Write operations are handled server-side via Admin SDK
      allow write: if false;
    }
    
    // User coaches collection - users can read/write their own coaches
    match /user_coaches/{coachId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Community coaches collection - all authenticated users can read, only creator can write
    match /community_coaches/{coachId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.verified == true;
      allow update: if isAuthenticated() && isCreator();
      allow delete: if isAuthenticated() && isCreator();
      
      // Copies subcollection - users can read all, create their own
      match /copies/{copyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Likes subcollection - users can read all, create/delete their own
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
        // No updates allowed for likes
        allow update: if false;
      }
      
      // Comments subcollection - users can read all, create their own, update/delete only their own
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
    }
    
    // ============================================
    // CHECKINS
    // ============================================
    
    // Weekly checkins - users can access their own checkins
    // Document ID format: {userId}_{date} OR check userId field in document
    match /weekly_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // Daily checkins - users can access their own checkins
    // Document ID format: {userId}_{date} OR check userId field in document
    match /daily_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        isUserDocument(checkinId) ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // FOOD & NUTRITION
    // ============================================
    
    // Food diary - users can access their own entries
    // Document ID format: {userId}_{date} OR check userId field in document
    match /food_diary/{diaryId} {
      allow read: if isAuthenticated() && (
        isUserDocument(diaryId) ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        isUserDocument(diaryId) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        isUserDocument(diaryId) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        isUserDocument(diaryId) ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // Food library - users can access their own food items
    match /food_library/{foodId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Saved meals collection - users can access their own saved meals
    match /saved_meals/{mealId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // WATER LOG
    // ============================================
    
    // Water log - users can access their own entries
    // Document ID format: {userId}_{date} OR check userId field in document
    match /water_log/{logId} {
      allow read: if isAuthenticated() && (
        isUserDocument(logId) ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        isUserDocument(logId) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        isUserDocument(logId) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        isUserDocument(logId) ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // WORKOUTS
    // ============================================
    
    // Workout logs - users can access their own logs
    match /workout_logs/{workoutId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Cardio log - users can access their own logs
    match /cardio_log/{cardioId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Workout programs - users can access their own programs
    match /workout_programs/{programId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Workout routines - users can access their own routines
    match /workout_routines/{routineId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Exercise library - users can access their own exercises
    match /exercise_library/{exerciseId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Personal records - users can read all, write their own
    match /personal_records/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // COMMUNITY FEATURES
    // ============================================
    
    // Community workout programs - all authenticated users can read, only creator can write
    match /community_workout_programs/{programId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && isCreator();
      allow delete: if isAuthenticated() && isCreator();
      
      // Copies subcollection - users can read all, create their own
      match /copies/{copyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Likes subcollection - users can read all, create/delete their own
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
        // No updates allowed for likes
        allow update: if false;
      }
      
      // Comments subcollection - users can read all, create their own, update/delete only their own
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Legacy community workouts - keep for backward compatibility
    match /community_workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && isCreator();
      allow delete: if isAuthenticated() && isCreator();
      
      // Copies subcollection - users can read all, create their own
      match /copies/{copyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Likes subcollection - users can read all, create/delete their own
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
        // No updates allowed for likes
        allow update: if false;
      }
      
      // Comments subcollection - users can read all, create their own, update/delete only their own
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
    }
    
    // ============================================
    // OTHER COLLECTIONS
    // ============================================
    
    // Supplements collection - users can access their own supplements
    match /supplements/{supplementId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Supplement logs collection - users can access their own logs
    match /supplement_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User cards collection - users can access their own cards
    match /user_cards/{cardId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
