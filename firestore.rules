rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // TESTING RULES - PERMISSIVE FOR DEVELOPMENT
    // ============================================
    // WARNING: These rules are for testing only!
    // DO NOT use in production - they allow too much access
    // ============================================
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // USER & PROFILE COLLECTIONS
    // ============================================
    
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Profiles collection - users can read/write their own profile, read others for community features
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(profileId);
    }
    
    // ============================================
    // MESSAGING
    // ============================================
    
    // Messages collection - users can read/write their own messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Daily coach messages collection - users can only read their own messages
    // Only server can write (via API route)
    match /daily_coach_messages/{messageId} {
      allow read: if isAuthenticated() && (
        messageId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      // Write operations are handled server-side via API routes
      allow write: if false;
    }
    
    // ============================================
    // COACHES
    // ============================================
    
    // Default coaches collection - authenticated users can read, allow writes for testing
    match /coaches/{coachId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Permissive for testing
    }
    
    // User coaches collection - users can read/write their own coaches
    match /user_coaches/{coachId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Community coaches collection - all authenticated users can read, only creator can write
    match /community_coaches/{coachId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid && request.resource.data.verified == true;
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // Copies subcollection
      match /copies/{copyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      }
      
      // Likes subcollection
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
    }
    
    // ============================================
    // CHECKINS
    // ============================================
    
    // Weekly checkins - users can access their own checkins
    match /weekly_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Daily checkins - users can access their own checkins
    match /daily_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // FOOD & NUTRITION
    // ============================================
    
    // Food diary - users can access their own entries
    match /food_diary/{diaryId} {
      allow read: if isAuthenticated() && (
        diaryId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        diaryId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Food library - users can access their own food items
    match /food_library/{foodId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Saved meals collection - users can access their own saved meals
    match /saved_meals/{mealId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // WATER LOG
    // ============================================
    
    // Water log - users can access their own entries
    match /water_log/{logId} {
      allow read: if isAuthenticated() && (
        logId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        logId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // WORKOUTS
    // ============================================
    
    // Workout logs - users can access their own logs
    match /workout_logs/{workoutId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Cardio log - users can access their own logs
    match /cardio_log/{cardioId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Workout programs - users can access their own programs
    match /workout_programs/{programId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Workout routines - users can access their own routines
    match /workout_routines/{routineId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Exercise library - users can access their own exercises
    match /exercise_library/{exerciseId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Personal records - users can read all, write their own
    match /personal_records/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // COMMUNITY FEATURES
    // ============================================
    
    // Community workout programs - all authenticated users can read, only creator can write
    match /community_workout_programs/{programId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    // Legacy community workouts - keep for backward compatibility
    match /community_workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // OTHER COLLECTIONS
    // ============================================
    
    // Supplements collection - users can access their own supplements
    match /supplements/{supplementId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User cards collection - users can access their own cards
    match /user_cards/{cardId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

