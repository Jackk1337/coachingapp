rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Profiles collection - users can read/write their own profile, read others for community features
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(profileId);
    }
    
    // Messages collection - users can only read/write their own messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Coaches collection - authenticated users can read, only admins can write
    // TODO: Implement admin check if needed (currently disabled for security)
    match /coaches/{coachId} {
      allow read: if isAuthenticated();
      allow write: if false; // Disable writes until admin check is implemented
    }
    
    // Weekly checkins - users can only access their own checkins
    // Document ID format: {userId}_{date} OR check userId field in document
    match /weekly_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Daily checkins - users can only access their own checkins
    // Document ID format: {userId}_{date} OR check userId field in document
    match /daily_checkins/{checkinId} {
      allow read: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        checkinId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Food diary - users can only access their own entries
    // Document ID format: {userId}_{date} OR check userId field in document
    match /food_diary/{diaryId} {
      allow read: if isAuthenticated() && (
        diaryId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        diaryId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Water log - users can only access their own entries
    // Document ID format: {userId}_{date} OR check userId field in document
    match /water_log/{logId} {
      allow read: if isAuthenticated() && (
        logId.matches(request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        logId.matches(request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Workout logs - users can only access their own logs
    match /workout_logs/{workoutId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Cardio log - users can only access their own logs
    match /cardio_log/{cardioId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Workout routines - users can only access their own routines
    match /workout_routines/{routineId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Exercise library - users can only access their own exercises
    match /exercise_library/{exerciseId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Food library - users can only access their own food items
    match /food_library/{foodId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Supplements collection (if exists) - users can only access their own supplements
    match /supplements/{supplementId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Saved meals collection - users can only access their own saved meals
    match /saved_meals/{mealId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User cards collection - users can only access their own cards
    match /user_cards/{cardId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Community workouts - all authenticated users can read, only creator can write
    match /community_workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    // Community meals - all authenticated users can read, only creator can write
    match /community_meals/{mealId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }
    
    // Personal records - users can read all, write their own
    match /personal_records/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
